# funplus 面试题

## 需求

- 问题描述:
  新游戏在开服后往往会有瞬时大量用户登录涌入的高峰流量，对服务器产生压力。
- 解决方案:
  开发开服排队系统，对到达服务器的大量用户进行队列缓冲，名为QueueService，根据服务器压力情况，逐步让队列中的用户拿到登录服务器的令牌（token），代表该用户请求可以被处理了，从而缓解登录高峰，排队中用户要能够“实时”知道自己在队伍中的位置变更。
- 开发要求:
   线下，无时间限制
- 交付:
  - 服务器QueueService：要求使用GoLang编写, 使用channel, 使用tcp长连接通信. 要求按照工业级代码标准开发, 比如高并发下吞吐瓶颈是否合理, 各种边界处理是否完备, 在系统发生错误时进程是否健壮
  - 客户端：对QueueService发起请求， 并对队列进行实时监控。要求使用GoLang编写, 使用tcp长连接通信
  - 文档：说明怎样部署和运行, 如何进行压测, 最好有完整压测数据(QPS, RTT, CPU, Mem等)
  
## 实现原理

- 每隔一定时间(默认100ms)给第一个client发送token,同时及时更新前n个排队顺序
- 每隔一定时间(默认1s)会主动刷新所有客户端当前排队号,单独协程,但不会长时间阻塞主协程,客户端当前排队不一定实时
- 客户端首次连接,会立刻受到当前排队号

## 编译执行

- 执行./build.sh 会在bin目录下生成server和client
- 进入bin目录: cd ./bin
- 启动服务器:  ./server
- 启动客户端:  ./client -n {count}, 可以带有一个参数,标识启动客户端的个数,默认1000
- 性能: 客户端执行完后,关闭服务器,会生成pprof
  - 统计cpu或者mem需要开启对应的代码，见main
  - 安装graphviz brew install graphviz
  - go tool pprof --pdf ./server ./mem.pprof > mem.pdf 
  - go tool pprof --pdf ./server ./cpu.pprof > cpu.pdf

## 其他

- 面试并没有过,不要使用
